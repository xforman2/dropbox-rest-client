<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task-2.2 - A Simple REST Client Exercise</title>
    <link rel="stylesheet" href="style.css">
    <style>
        button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<div class="wrp">

    <h1 class="he">
        <img src="dd.png" width="50" height="50" style="vertical-align: middle;">
        Dropbox REST Client
    </h1>

    <!-- Connect Button -->
    <button id="connectBtn">Connect</button>
    <div id="accountInfo"></div>

    <hr>

    <!-- Upload Form -->
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" name="file" required>
        <button type="submit" id="uploadBtn" disabled>Upload</button>
    </form>
    <div id="uploadStatus"></div>

    <hr>

    <!-- ListBox -->
    <button id="listBtn" disabled>List Files</button>
    <ul id="fileList"></ul>

    <hr>

    <!-- Download -->
    <button id="downloadBtn" disabled>Download Selected File</button>
    <div id="downloadStatus"></div>

    <script>
        const connectBtn = document.getElementById("connectBtn");
        const listBtn = document.getElementById("listBtn");
        const uploadBtn = document.getElementById("uploadBtn");
        const downloadBtn = document.getElementById("downloadBtn");

        // Connect → go to OAuth servlet
        connectBtn.addEventListener("click", () => {
            window.location.href = "DboxAuth";
        });

        // Upload
        document.getElementById("uploadForm").addEventListener("submit", (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            fetch("DboxUpload", {
                method: "POST",
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                document.getElementById("uploadStatus").innerHTML = data;
            });
        });

        // List Files
        listBtn.addEventListener("click", () => {
            fetch("DboxList")
            .then(response => response.json())
            .then(files => {
                const ul = document.getElementById("fileList");
                ul.innerHTML = "";
                if (files.length === 0) {
                    ul.innerHTML = "<li>No files found</li>";
                    return;
                }
                files.forEach(file => {
                    const li = document.createElement("li");
                    li.textContent = file.name;
                    li.addEventListener("click", () => {
                        ul.querySelectorAll("li").forEach(item => item.classList.remove("selected"));
                        li.classList.add("selected");
                    });
                    ul.appendChild(li);
                });
            })
            .catch(err => console.error(err));
        });

        // Download Selected File
        downloadBtn.addEventListener("click", () => {
            const selected = document.querySelector("#fileList li.selected");
            if (!selected) {
                alert("Please select a file to download");
                return;
            }
            const fileName = selected.textContent;
            window.open(`DboxDownload?file=${encodeURIComponent(fileName)}`, "_blank");
        });

        // Check token and enable/disable buttons
        async function checkToken() {
            try {
                let res = await fetch("DboxList");
                let text = await res.text();

                if (text.startsWith("[") && JSON.parse(text)) {
                    // Token exists → enable buttons
                    listBtn.disabled = false;
                    uploadBtn.disabled = false;
                    downloadBtn.disabled = false;
                } else {
                    // No token → keep them disabled
                    listBtn.disabled = true;
                    uploadBtn.disabled = true;
                    downloadBtn.disabled = true;
                }
            } catch (err) {
                listBtn.disabled = true;
                uploadBtn.disabled = true;
                downloadBtn.disabled = true;
            }
        }

        // Run on page load
        checkToken();
    </script>
</div>
</body>
</html>
